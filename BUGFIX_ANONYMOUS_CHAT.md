# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –û–®–ò–ë–û–ö –í –ë–û–¢–ï –ê–ù–û–ù–ò–ú–ù–û–ì–û –ß–ê–¢–ê

**–î–∞—Ç–∞:** 3 —è–Ω–≤–∞—Ä—è 2026
**–í–µ—Ä—Å–∏—è:** v2.0 (Critical Bugfix)

---

## üìã –ù–ê–ô–î–ï–ù–ù–´–ï –û–®–ò–ë–ö–ò

### ‚ùå –û–®–ò–ë–ö–ê #1: –û–ë–ú–ï–ù –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò –†–ê–ë–û–¢–ê–ï–¢ –¢–û–õ–¨–ö–û –í –û–î–ù–£ –°–¢–û–†–û–ù–£

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§—É–Ω–∫—Ü–∏—è `handle_chat_message` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä—É –ë–ï–ó –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
- –ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü–∞—Ä—Ç–Ω—ë—Ä –ù–ï –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —á–∞—Ç–∞, –∂–∞–ª–æ–± –∏ –æ—Ü–µ–Ω–æ–∫
- –ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —É –Ω–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):**
```python
async def handle_chat_message(message: Message, state: FSMContext):
    # ...
    try:
        await bot_instance.send_message(partner_id, message.text)  # ‚ùå –¢–û–õ–¨–ö–û –¢–ï–ö–°–¢!
        logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {partner_id}")
    except Exception as send_error:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {send_error}")
```

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ + –¥–æ–±–∞–≤–∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ.

---

### ‚ùå –û–®–ò–ë–ö–ê #2: –û–¢–°–£–¢–°–¢–í–£–ï–¢ –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ü–ê–†–¢–ù–Å–†–ê

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ `in_chat`
- –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä —É–∂–µ –∑–∞–≤–µ—Ä—à–∏–ª —á–∞—Ç –Ω–∞ —Å–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ - —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–¥—ë—Ç –≤ –ø—É—Å—Ç–æ—Ç—É
- –ï—Å–ª–∏ –ø–∞—Ä—Ç–Ω—ë—Ä –≤—ã—à–µ–ª –∏–∑ –±–æ—Ç–∞ - –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–º

**–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):**
```python
# –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ active_chats –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞!
if not chat_id or not partner_id or user_id not in active_chats:
    # –≠—Ç–æ –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ, –Ω–æ –Ω–µ–ø–æ–ª–Ω–æ
    ...
```

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏–ª–∏ –ø–æ–ª–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ –ò —á—Ç–æ –æ–±–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ in_chat
if not chat_id or not partner_id or user_id not in active_chats:
    await message.answer("‚ùå –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω...")
    await state.clear()
    return

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –µ—â—ë –≤ —Ç–æ–º –∂–µ —á–∞—Ç–µ
if partner_id not in active_chats or active_chats[partner_id].get('chat_id') != chat_id:
    await message.answer("‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª —á–∞—Ç...")
    await state.clear()
    active_chats.pop(user_id, None)
    return
```

---

### ‚ùå –û–®–ò–ë–ö–ê #3: –ü–ê–†–¢–ù–Å–† –ù–ï –ü–û–õ–£–ß–ê–ï–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ò

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ö–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω –ø–∞—Ä—Ç–Ω—ë—Ä - —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∑–Ω–∞—ë—Ç –æ–± —ç—Ç–æ–º
- –ù–æ –ø–∞—Ä—Ç–Ω—ë—Ä –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–æ–∂–∏–¥–∞–Ω–∏—è" –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- –ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è
- –î–∏–∞–ª–æ–≥ –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç

**–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):**
```python
async def find_partner(user_id: int, category: str, search_filters: dict, bot: Bot):
    # ...
    if waiting_users[category]:
        partner_id = waiting_users[category].pop(0)
        # ...
        active_chats[partner_id] = {'partner_id': user_id, 'chat_id': chat_id}
        # ‚ùå –ü–∞—Ä—Ç–Ω—ë—Ä—É –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏!
        return partner_id, chat_id
```

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ —á–µ—Ä–µ–∑ –µ–≥–æ FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç:
```python
if partner_id in user_fsm_contexts:
    partner_state = user_fsm_contexts[partner_id]
    await partner_state.set_state(UserStates.in_chat)
    await partner_state.update_data(chat_id=chat_id, partner_id=user_id, category=category)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    try:
        await bot.send_message(
            partner_id,
            "üéâ **–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω!**\n\nüí¨ –í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ:",
            reply_markup=get_chat_actions_keyboard()
        )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞: {e}")
```

---

### ‚ùå –û–®–ò–ë–ö–ê #4: –û–¢–°–£–¢–°–¢–í–£–ï–¢ –ì–õ–û–ë–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï FSM –ö–û–ù–¢–ï–ö–°–¢–û–í

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –§—É–Ω–∫—Ü–∏—è `find_partner` –ø–æ–ª—É—á–∞–ª–∞ `bot` –Ω–æ –Ω–µ –ø–æ–ª—É—á–∞–ª–∞ `state`
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏–∑ –¥—Ä—É–≥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
- –ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –º–æ–≥ –±—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —Å –ø–æ–º–æ—â—å—é –µ–≥–æ FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π):**
```python
async def find_partner(user_id: int, category: str, search_filters: dict, bot: Bot):
    # ‚ùå –ù–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ state!
    # ‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –ø–∞—Ä—Ç–Ω—ë—Ä–∞
```

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ `user_fsm_contexts`:
```python
# –ù–æ–≤–æ–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
user_fsm_contexts = {}  # user_id -> FSMContext

# –í cmd_start —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
user_fsm_contexts[user_id] = state

# –í find_partner –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞
if partner_id in user_fsm_contexts:
    partner_state = user_fsm_contexts[partner_id]
    await partner_state.set_state(UserStates.in_chat)
```

---

## ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –í –ö–û–î–ï

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –î–æ–±–∞–≤–ª–µ–Ω–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
```python
# –ù–û–í–û–ï: –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
user_fsm_contexts = {}  # user_id -> FSMContext
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è find_partner
```python
async def find_partner(user_id: int, category: str, search_filters: dict, bot: Bot, state: FSMContext):
    # –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç state –ø–∞—Ä–∞–º–µ—Ç—Ä
    # –ò–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
    # –ú–æ–∂–µ—Ç —É–≤–µ–¥–æ–º–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
    ...
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 3: –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤ handle_chat_message
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
if not chat_id or not partner_id or user_id not in active_chats:
    await message.answer("‚ùå –ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω...")
    await state.clear()
    return

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ä—Ç–Ω—ë—Ä –≤—Å—ë –µ—â—ë –≤ —á–∞—Ç–µ
if partner_id not in active_chats or active_chats[partner_id].get('chat_id') != chat_id:
    await message.answer("‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª —á–∞—Ç...")
    await state.clear()
    active_chats.pop(user_id, None)
    return
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 4: –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
```python
try:
    await bot_instance.send_message(partner_id, message.text)
    logger.info(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {partner_id}: {message.text[:50]}")
except Exception as send_error:
    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä—É {partner_id}: {send_error}")
    await message.answer("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è...")
    # –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
    db.end_chat(chat_id)
    active_chats.pop(user_id, None)
    active_chats.pop(partner_id, None)
    await state.clear()
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ 5: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ FSM –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ –≤—Å–µ—Ö handlers
```python
# –í cmd_start
user_fsm_contexts[user_id] = state

# –í cmd_search
user_fsm_contexts[user_id] = state

# –í handle_search_filter
user_fsm_contexts[user_id] = state
```

---

## üî¨ –ö–ê–ö –†–ê–ë–û–¢–ê–ï–¢ –ê–ù–û–ù–ò–ú–ù–´–ô –ß–ê–¢ - –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê

–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –≤ –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö —á–∞—Ç–∞—Ö Telegram –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:

### 1Ô∏è‚É£ –ü–û–ò–°–ö –ü–ê–†–¢–ù–Å–†–ê (Matching)
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A ‚Üí /start ‚Üí –ù–∞–∂–∏–º–∞–µ—Ç "üî• –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞"
                           ‚Üì
                      Bot –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
                           ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B ‚Üí /start ‚Üí –ù–∞–∂–∏–º–∞–µ—Ç "üî• –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞"
                           ‚Üì
              Bot –Ω–∞—Ö–æ–¥–∏—Ç A –≤ –æ—á–µ—Ä–µ–¥–∏
                           ‚Üì
         ‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è Chat ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, uuid)
                           ‚Üì
     –û–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                           ‚Üì
       –û–±–∞ –ø–µ—Ä–µ—Ö–æ–¥—è—Ç –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UserStates.in_chat
```

### 2Ô∏è‚É£ –û–ë–ú–ï–ù –°–û–û–ë–©–ï–ù–ò–Ø–ú–ò (Message Routing)
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A:                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B:
  –ü–∏—à–µ—Ç: "–ü—Ä–∏–≤–µ—Ç"                  
     ‚Üì                             
Bot –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ             
     ‚Üì                             
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç:                         
  ‚úì user_id –≤ active_chats        
  ‚úì partner_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç         
  ‚úì chat_id –∞–∫—Ç–∏–≤–µ–Ω               
  ‚úì partner –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ in_chat   
     ‚Üì                             
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä—É ‚Üê ‚Üí –ü–æ–ª—É—á–∞–µ—Ç: "–ü—Ä–∏–≤–µ—Ç"
                                   ‚Üì
                              –ú–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å
                                   ‚Üì
                              –ü–∏—à–µ—Ç: "–ü—Ä–∏–≤–µ—Ç! üëã"
                                   ‚Üì
                              Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞–º
```

### 3Ô∏è‚É£ –ó–ê–í–ï–†–®–ï–ù–ò–ï –ß–ê–¢–ê (End Chat)
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –Ω–∞–∂–∏–º–∞–µ—Ç "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç"
                          ‚Üì
         Bot –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä—É: "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª"
                          ‚Üì
       –û–±–∞ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ active_chats
                          ‚Üì
       –û–±–∞ —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è in_chat
                          ‚Üì
      –û–±–æ–∏–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏
                          ‚Üì
         –ü–æ—Å–ª–µ –æ—Ü–µ–Ω–∫–∏ - –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
```

---

## üìä –°–†–ê–í–ù–ï–ù–ò–ï –û–®–ò–ë–û–ö –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô

| –ü–∞—Ä–∞–º–µ—Ç—Ä | ‚ùå –î–û | ‚úÖ –ü–û–°–õ–ï |
|----------|-------|----------|
| –°–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–±–æ–∏–º? | –ù–µ—Ç, –ø–∞—Ä—Ç–Ω—ë—Ä—É —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç | –î–∞, —Ç–µ–∫—Å—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è |
| –ö–Ω–æ–ø–∫–∏ –≤–∏–¥–Ω—ã –ø–∞—Ä—Ç–Ω—ë—Ä—É? | –ù–µ—Ç –∫–Ω–æ–ø–æ–∫ | –î–∞, –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–Ω—ã |
| –ü–∞—Ä—Ç–Ω—ë—Ä —É–∑–Ω–∞—ë—Ç –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏? | –ù–µ—Ç | –î–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–∞—Ç–∞? | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑—Ä—ã–≤–∞ —Å–≤—è–∑–∏? | –ü–ª–æ—Ö–∞—è | –•–æ—Ä–æ—à–∞—è |
| FSM —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è? | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ü–æ–ª–Ω–∞—è |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ? | –ë–∞–∑–æ–≤–æ–µ | –î–µ—Ç–∞–ª—å–Ω–æ–µ |

---

## üöÄ –†–ï–ó–£–õ–¨–¢–ê–¢

‚úÖ **–û–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –û–ë–ï —Å—Ç–æ—Ä–æ–Ω—ã**
‚úÖ **–û–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∏–¥—è—Ç –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π**
‚úÖ **–ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏**
‚úÖ **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å —á–∞—Ç–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π**
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–≤—è–∑–∏**
‚úÖ **–ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π**

---

## üß™ –ö–ê–ö –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç:**
   ```bash
   python bot/main.py
   ```

2. **–û—Ç–∫—Ä–æ–π—Ç–µ –¥–≤–µ —Å–µ—Å—Å–∏–∏ Telegram:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –±–æ—Ç–æ–º –≤ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö/–∞–∫–∫–∞—É–Ω—Ç–∞—Ö

3. **–¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤—ã–π –æ–±–º–µ–Ω —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏**
   - –û–±–∞ –Ω–∞–∂–∏–º–∞—é—Ç "üî• –ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞"
   - –ñ–¥—É—Ç 5 —Å–µ–∫—É–Ω–¥
   - –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å "üéâ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞–π–¥–µ–Ω!"
   - –ü–µ—Ä–≤—ã–π –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
   - **–í—Ç–æ—Ä–æ–π –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –¢–û–õ–¨–ö–û —Ç–µ–∫—Å—Ç (–±–µ–∑ –∫–Ω–æ–ø–æ–∫)**
   - –í—Ç–æ—Ä–æ–π –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å

4. **–¢–µ—Å—Ç 2: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —á–∞—Ç–∞**
   - –ü–µ—Ä–≤—ã–π –Ω–∞–∂–∏–º–∞–µ—Ç "‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–∞—Ç"
   - –í—Ç–æ—Ä–æ–π –≤–∏–¥–∏—Ç "‚ùå –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª —á–∞—Ç"
   - –û–±–æ–∏–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏

5. **–¢–µ—Å—Ç 3: –†–∞–∑—Ä—ã–≤ —Å–≤—è–∑–∏**
   - –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - –í—Ç–æ—Ä–æ–π –ø—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
   - **–î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**

---

## üìù –ó–ê–ú–ï–¢–ö–ò –†–ê–ó–†–ê–ë–û–¢–ß–ò–ö–ê

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:
1. **–ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ `user_fsm_contexts`** - –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
2. **–ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `active_chats`** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –æ–±–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç–µ
3. **–Ø–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞** - –ø–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω –≥–∞–¥–∞—Ç—å –∫–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º:
1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –º–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
2. **Redis** - –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
3. **WebSocket** - –¥–ª—è —Ä–µ–∞–ª-—Ç–∞–π–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–æ polling
4. **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π** - –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

---

## üìû –ö–û–ù–¢–ê–ö–¢–´

–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –µ—â—ë –æ—à–∏–±–∫–∏ - —Å–æ–∑–¥–∞–π—Ç–µ Issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
